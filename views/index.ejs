<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>MahaFIR Downloader</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body {
      background-color: #f8f9fa;
    }

    #log {
      height: 260px;
      overflow-y: auto;
      background: #000;
      color: #0f0;
      padding: 10px;
      font-size: 14px;
      border-radius: 5px;
    }

    #fileTree {
      max-height: 260px;
      overflow-y: auto;
    }

    .folder {
      font-weight: bold;
    }

    .file {
      padding-left: 20px;
    }
  </style>
</head>

<body>
  <div class="container py-4">

    <h2 class="mb-4 text-center">üìÅ MahaFIR Downloader</h2>

    <div class="row g-4">

      <!-- FORM -->
      <div class="col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <form id="downloadForm">

              <div class="mb-3">
                <label class="form-label">From Date</label>
                <input type="date" name="fromDate" class="form-control" required>
              </div>

              <div class="mb-3">
                <label class="form-label">To Date</label>
                <input type="date" name="toDate" class="form-control" required>
              </div>

              <div class="mb-3">
                <label class="form-label">Request Name</label>
                <input type="text" name="requestName" class="form-control" required>
              </div>

              <div class="mb-3">
                <label class="form-label">Select Cities</label>

                <div class="dropdown w-100">
                  <button class="btn btn-outline-secondary w-100 text-start dropdown-toggle" type="button"
                    id="cityDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false">
                    Select Cities...
                  </button>
                  <div class="dropdown-menu w-100 p-3" aria-labelledby="cityDropdownBtn">
                    <input type="text" id="citySearch" class="form-control mb-2" placeholder="Search cities...">

                    <div class="form-check mb-2">
                      <input class="form-check-input" type="checkbox" id="selectAllCities">
                      <label class="form-check-label fw-bold" for="selectAllCities">Select All</label>
                    </div>

                    <div id="cityList" style="max-height: 200px; overflow-y: auto;">
                      <!-- Cities injected here -->
                      <div class="text-muted small">Loading...</div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Select Police Stations</label>
                <div class="dropdown w-100">
                  <button class="btn btn-outline-secondary w-100 text-start dropdown-toggle" type="button"
                    id="stationDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false">
                    Select Stations...
                  </button>
                  <div class="dropdown-menu w-100 p-3" aria-labelledby="stationDropdownBtn">
                    <div class="form-check mb-2">
                      <input class="form-check-input" type="checkbox" id="selectAllStations" checked>
                      <label class="form-check-label fw-bold" for="selectAllStations">Select All Stations</label>
                    </div>
                    <div id="stationList" style="max-height: 300px; overflow-y: auto;">
                      <div id="stationPlaceholder" class="text-muted small">Select a city first...</div>
                    </div>
                  </div>
                </div>
              </div>

              <button class="btn btn-primary w-100" type="submit">
                ‚ñ∂ Start Download
              </button>

            </form>
          </div>
        </div>
      </div>

      <!-- RIGHT SIDE -->
      <div class="col-lg-8">

        <!-- LOG -->
        <div class="card shadow-sm mb-3">
          <div class="card-header bg-dark text-white">
            Live Download Log
          </div>
          <div class="card-body p-2">
            <pre id="log"></pre>
          </div>
        </div>

        <!-- FILE MANAGER -->
        <div class="card shadow-sm">
          <div class="card-header">
            Download Folder
          </div>
          <div class="card-body" id="fileTree">
            <div class="text-muted">Waiting for download...</div>
          </div>
        </div>

      </div>

      <hr>
      <h2>Downloaded Requests</h2>
      <div id="downloadsTree"></div>
    </div>

    <script src="/main.js"></script>

    <script>
      /* ------------------ CACHE & STATE ------------------ */
      const cityStationsMap = {}; // Cache: { cityValue: [ {value, text} ] }
      const loadedCities = new Set(); // Track which cities are currently "active" in the station list

      /* ------------------ LOAD CITIES (CHECKBOX DROPDOWN) ------------------ */
      fetch("/cities")
        .then(res => res.json())
        .then(cities => {
          const cityList = document.getElementById("cityList");
          cityList.innerHTML = ""; // clear loading msg

          cities.forEach(c => {
            // Container
            const div = document.createElement("div");
            div.className = "form-check";

            // Checkbox
            const chk = document.createElement("input");
            chk.className = "form-check-input city-checkbox";
            chk.type = "checkbox";
            chk.name = "cityValue"; // This ensures it hits the form data
            chk.value = c.value;
            chk.id = "city_" + c.value;
            chk.dataset.text = c.text; // Store text for group header

            // Label
            const lbl = document.createElement("label");
            lbl.className = "form-check-label";
            lbl.htmlFor = "city_" + c.value;
            lbl.textContent = c.text;

            div.appendChild(chk);
            div.appendChild(lbl);
            cityList.appendChild(div);
          });

          // Update Button Text Logic
          const checkboxes = document.querySelectorAll(".city-checkbox");
          const btn = document.getElementById("cityDropdownBtn");

          function updateBtn() {
            const checked = document.querySelectorAll(".city-checkbox:checked");
            if (checked.length === 0) btn.textContent = "Select Cities...";
            else if (checked.length <= 2) btn.textContent = Array.from(checked).map(c => c.nextSibling.textContent).join(", ");
            else btn.textContent = `${checked.length} Cities Selected`;
          }

          /* ------------------ STATION HANDLING ------------------ */
          const stationList = document.getElementById("stationList");
          const stationBtn = document.getElementById("stationDropdownBtn");
          const selectAllStationsChk = document.getElementById("selectAllStations");

          async function handleCityChange(e) {
            const chk = e.target;
            const cityVal = chk.value;
            const cityName = chk.dataset.text;

            updateBtn(); // Update city button label

            if (chk.checked) {
              await addStationsForCity(cityVal, cityName);
            } else {
              removeStationsForCity(cityVal);
            }
            updateStationBtn();
          }

          async function addStationsForCity(cityVal, cityName) {
            // Avoid adding duplicate
            if (loadedCities.has(cityVal)) return;

            // Remove "Select a city first" placeholder if present
            if (document.getElementById("stationPlaceholder")) {
              stationList.innerHTML = "";
            }

            // Create Group Container (so we can remove easily)
            const groupDiv = document.createElement("div");
            groupDiv.id = `group_city_${cityVal}`;
            groupDiv.className = "mb-3";

            // Header
            const header = document.createElement("h6");
            header.className = "fw-bold text-primary border-bottom pb-1";
            header.style.marginTop = "10px";
            header.textContent = cityName;
            groupDiv.appendChild(header);

            // Loading indicator for this group
            const loading = document.createElement("div");
            loading.className = "small text-muted";
            loading.textContent = "Loading stations...";
            groupDiv.appendChild(loading);

            stationList.appendChild(groupDiv);
            loadedCities.add(cityVal);

            // Fetch Stations
            let stations = cityStationsMap[cityVal];
            if (!stations) {
              try {
                const res = await fetch(`/stations?cityValue=${cityVal}`);
                if (!res.ok) throw new Error("Failed");
                stations = await res.json();
                cityStationsMap[cityVal] = stations;
              } catch (err) {
                loading.textContent = "‚ùå Failed to load stations";
                return;
              }
            }

            // Render Stations
            groupDiv.removeChild(loading); // Remove loading

            stations.forEach(st => {
              const div = document.createElement("div");
              div.className = "form-check ms-2";

              const stChk = document.createElement("input");
              stChk.className = "form-check-input station-checkbox";
              stChk.type = "checkbox";
              stChk.name = `stations[${cityVal}]`; // Nested name for backend
              stChk.value = st.value;
              stChk.id = `st_${cityVal}_${st.value}`;
              stChk.checked = true; // Default to checked

              const lbl = document.createElement("label");
              lbl.className = "form-check-label";
              lbl.htmlFor = stChk.id;
              lbl.textContent = st.text;

              div.appendChild(stChk);
              div.appendChild(lbl);
              groupDiv.appendChild(div);
            });
            updateStationBtn();
          }

          function removeStationsForCity(cityVal) {
            const group = document.getElementById(`group_city_${cityVal}`);
            if (group) group.remove();
            loadedCities.delete(cityVal);

            if (loadedCities.size === 0) {
              stationList.innerHTML = '<div id="stationPlaceholder" class="text-muted small">Select a city first...</div>';
            }
            updateStationBtn();
          }

          function updateStationBtn() {
            const allSt = document.querySelectorAll(".station-checkbox");
            const checkedSt = document.querySelectorAll(".station-checkbox:checked");
            const checkedCount = checkedSt.length;

            if (allSt.length === 0) {
              stationBtn.textContent = "Select Stations...";
              return;
            }

            if (checkedCount === allSt.length) {
              stationBtn.textContent = "All Sub Stations Selected";
            } else {
              stationBtn.textContent = `${checkedCount} Stations Selected`;
            }

            // Handle "Select All" checkbox state
            selectAllStationsChk.checked = (allSt.length > 0 && checkedCount === allSt.length);
          }

          // Hook events
          checkboxes.forEach(c => c.addEventListener("change", handleCityChange));

          /* ------------------ STATION SELECT ALL ------------------ */
          selectAllStationsChk.addEventListener("change", (e) => {
            const isChecked = e.target.checked;
            document.querySelectorAll(".station-checkbox").forEach(cb => {
              cb.checked = isChecked;
            });
            updateStationBtn();
          });

          // Also need to listen to individual station checks to update the button
          // Since stations are dynamic, we use delegation (on stationList)
          stationList.addEventListener("change", (e) => {
            if (e.target.classList.contains("station-checkbox")) {
              updateStationBtn();
            }
          });


          // Search Filter for Cities (existing)
          const searchInput = document.getElementById("citySearch");
          searchInput.addEventListener("input", (e) => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll("#cityList .form-check").forEach(div => {
              const text = div.textContent.toLowerCase();
              div.style.display = text.includes(term) ? "block" : "none";
            });
          });

          // Select All Cities (existing updated)
          document.getElementById("selectAllCities").addEventListener("change", (e) => {
            const isChecked = e.target.checked;
            const visible = Array.from(document.querySelectorAll("#cityList .form-check")).filter(d => d.style.display !== "none");
            visible.forEach(div => {
              const chk = div.querySelector("input");
              if (chk.checked !== isChecked) {
                chk.checked = isChecked;
                // Manually trigger change to fetch stations
                chk.dispatchEvent(new Event("change"));
              }
            });
            updateBtn();
          });

        });

      /* ------------------ SIMPLE FILE TREE FROM LOG ------------------ */
      let currentFolder = null;

      function handleFileTree(line) {
        line = line.trim();
        if (!line) return;

        // New City folder
        if (line.startsWith("Processing City:")) {
          const cityDiv = document.createElement("div");
          cityDiv.className = "folder mt-2 text-primary";
          cityDiv.textContent = "üèô " + line.replace("Processing City:", "").trim();
          fileTree.appendChild(cityDiv);
          currentFolder = null; // Reset station folder
        }

        // New station folder
        if (line.startsWith("Processing station:")) {
          currentFolder = document.createElement("div");
          currentFolder.className = "folder mb-1 ms-3";
          currentFolder.textContent = "üìÇ " + line.replace("Processing station:", "").trim();
          fileTree.appendChild(currentFolder);
        }

        // PDF file
        if (line.startsWith("Saved FIR:") && currentFolder) {
          const file = document.createElement("div");
          file.className = "file text-muted ms-5";
          file.textContent = "üìÑ " + line.replace("Saved FIR:", "").trim();
          fileTree.appendChild(file);
        }

        // Completion
        if (line === "DOWNLOAD COMPLETE") {
          const doneMsg = document.createElement("div");
          doneMsg.className = "text-success fw-bold mt-2";
          doneMsg.textContent = "‚úî Download Completed Successfully";
          fileTree.appendChild(doneMsg);
        }
      }


      async function loadDownloads() {
        const res = await fetch("/downloads");
        const data = await res.json();

        const container = document.getElementById("downloadsTree");
        container.innerHTML = "";

        data.forEach(req => {
          const reqDetails = document.createElement("details");
          reqDetails.style.marginBottom = "10px";

          const reqSummary = document.createElement("summary");
          reqSummary.innerHTML = `
      <strong>üìÅ ${req.request_name}</strong>
      <br>
      <small>City: ${req.city} | ${new Date(req.created_at).toLocaleString()}</small>
    `;
          reqDetails.appendChild(reqSummary);

          Object.keys(req.stations).forEach(station => {
            const stDetails = document.createElement("details");
            stDetails.style.marginLeft = "20px";

            const stSummary = document.createElement("summary");
            stSummary.innerHTML = `üìÇ <b>${station}</b>`;
            stDetails.appendChild(stSummary);

            req.stations[station].forEach(fir => {
              const file = document.createElement("div");
              file.style.marginLeft = "20px";
              file.innerHTML = `
          üìÑ <a href="/${fir.pdf_path.replace(/\\/g, "/")}" target="_blank">
            FIR ${fir.fir_no}
          </a>
        `;
              stDetails.appendChild(file);
            });

            reqDetails.appendChild(stDetails);
          });

          container.appendChild(reqDetails);
        });
      }

      loadDownloads();
    </script>

</body>

</html>